# 作业五

一、考虑在公共属性 a 上连接关系 R(a,b)和 S(a,c,d)，假设表上没有可用的索引来加速连接算法。
缓冲区中有 B=75 页
表 R 包含 M= 2400 个页面，每个页面包含 80 个元组
表 S 包含 N = 1200 个页面，每个页面包含 100 个元组
请回答以下关于计算连接的 I/O 开销的问题。您可以假设最简单的开销模型，即每次只读写一个页面。你还可以假设你需要一个缓冲块来保存演变中的输出块，以及一个输入块来保存内部关系的当前输入块。你可以忽略写最终结果的成本。
A. 以 R 为外部关系，S 为内部关系的块嵌套循环连接
B. 以 S 为外部关系，R 为内部关系的块嵌套循环连接

**答：**

**A.** 缓冲区中有 B=75 页，需要一个块输出，一个块保存内部关系的块，故一次性可读入外关系的 B-1-1=73 页。外关系 R 的每页只读一次，I/O 开销为 M=2400；内关系 S 扫描 ⌈M/73⌉=33 次，合计 33N=39600 次。忽略写最终结果的成本，总 I/O 开销为 2400 + 39600 = 42000。

**B.** 外关系 S 的每页只读一次，I/O 开销为 N=1200；内关系 R 扫描 ⌈N/73⌉=17 次，合计 17M=40800次。忽略写最终结果的成本，总 I/O 开销为 1200 + 40800 = 42000。



二、设关系 R(X, Y)和 S(Y, Z)，R 共有 1000 个元组，S 共有 1500 个元组，每个块中可容纳 20 个 R 元组或 50 个 S 元组。S 中 Y 不同值的个数为 20。
(1) 若在 S.Y 上建有聚簇索引，估计 R 和 S 基于索引连接的 IO 代价。
(2) 若在 S.Y 上建有非聚簇索引，估计 R 和 S 基于索引连接的 IO 代价。

**答：**

由题，T(R)=1000, T(S)=1500, V(S, Y)=20，则 B(R)=T(R)/20=50, B(S)=T(S)/50=30。

**(1)** R 的每块只读一次，合计 B(R)=50 次 I/O。因为索引是聚簇索引，所以对于 R 的每个元组 r，S 中能与 r 连接的元组一定连续存储于 S 的文件中，约占 ⌈B(S)/V(S,Y)⌉=2 个块，合计 2×T(R)=2000 次 I/O。故 R 和 S 基于索引连接的 I/O 代价为 B(R)+T(R)×⌈B(S)/V(S,Y)⌉=2050。

**(2)** R 的每块只读一次，合计 B(R)=50 次 I/O。对于 R 的每个元组 r，S 中平均约有 T(S)/V(S, Y)=75 个元组能与 r 连接。因为索引是非聚簇索引，这些元组在文件中不一定连续存储，最坏情况下，读每个元组产生 1 次 I/O，合计 T(R)T(S)/V(S, Y)=75000 次 I/O。故 R 和 S 基于索引连接的 I/O 代价为 B(R)+T(R)T(S)/V(S, Y)=75050。



三、已知 2 个关系 R(A, B)和 S(B, C)，其主键分别为 R.A 和 S.B。R 有 40000 个元组，S 有 60000 个元组，一块中可以容纳 20 个 R 元组或 30 个 S 元组。设 2 个关系均采用聚簇存储，且每个关系中的元组均已按照其主键值递增排序。现在要执行自然连接操作 R ⨝ S。设缓冲区中可用内存页数为 M = 41。回答下列问题：
(1) 采用嵌套循环连接算法执行 R ⨝ S 分别需要进行多少次 I/O？给出具体分析过程。
(2) 采用归并连接算法执行R ⨝ S分别需要进行多少次I/O？给出具体分析过程。
(3) 设 R.B 是关系 R 的外键，参照 S.B。如果 R ⨝ S 的结果中元组的平均大小是 R 中元组平均大小的 1.2 倍，R ⨝ S 的结果中元组的平均大小是 S 中元组平均大小的 2 倍，那么在外存中存储 R ⨝ S 的结果需要占用多少个块（页）？给出具体分析过程。

**答：**

**(1)** 由题，T(R)=40000, T(S)=60000, B(R)=T(R)/20=2000, B(S)=T(S)/30=2000。

① 如果采用基于元组的嵌套循环连接，且以 R 为外部关系：
外关系 R 的每个元组只读 1 次，每次产生 1 个 I/O，合计 T(R) 次 I/O。内关系 S 的每个元组读 T(R) 次，每次产生 1 个 I/O，合计 T(R)T(S)次 I/O。从而总的 I/O 代价为 T(R)(1+T(S))=2400040000。

② 如果采用基于元组的嵌套循环连接，且以 S 为外部关系：
外关系 S 的每个元组只读 1 次，每次产生 1 个 I/O，合计 T(S) 次 I/O。内关系 S 的每个元组读 T(S) 次，每次产生 1 个 I/O，合计 T(S)T(R) 次 I/O。从而总的 I/O 代价为 T(S)(1+T(R))=2400060000。

③ 如果采用基于块的嵌套循环连接，且以 R 为外部关系：
缓冲区中可用内存页数为 M = 41，故一次性可读入外关系的 M-1=40 页。外关系 R 的每页只读 1 次，I/O 开销为 B(R)；内关系 S 扫描 B(R)/(M-1) 次，合计 B(S)B(R)/(M-1) 次。忽略写最终结果的成本，总 I/O 开销为 B(R)+B(S)B(R)/(M-1)=102000。

④ 如果采用基于块的嵌套循环连接，且以 S 为外部关系：

缓冲区中可用内存页数为 M = 41，故一次性可读入外关系的 M-1=40 页。外关系 S 的每页只读 1 次，I/O 开销为 B(S)；内关系 S 扫描 B(S)/(M-1) 次，合计 B(R)B(S)/(M-1) 次。忽略写最终结果的成本，总 I/O 开销为 B(S)+B(R)B(S)/(M-1)=102000。

**(2)** 在对 R 创建归并段时，R 的每块只读 1 次，合计 B(R) 次 I/O，将 R 的归并段全部写入文件，需 B(R) 次 I/O，共计 2B(R) 次。而关系 S 已经按照 S.B 排序，因此无需创建归并段。在归并阶段，对 R 和 S 每个归并段各扫描一次，合计 B(R)+B(S) 次 I/O。所以总的 I/O 开销为 3B(R)+B(S)=8000。

**(3)** 由于 S.B 是 S 的主键，则根据实体完整性约束，S.B 能够确定 S 中唯一的一个元组。由于 R.B 是 R 参照 S.B 的外键，所以 R.B 的某个取值一定等于 S.B 的某个取值。综上，R ⨝ S 的结果的个数与 T(R) 相同，为 40000 个。
因为 R ⨝ S 的结果中元组的平均大小是 R 中元组平均大小的 1.2 倍，所以存储 R ⨝ S 的结果需要占用 1.2×B(R)=2400 个块。



四、设教学管理数据库有如下 3 个关系模式：
S(S#, SNAME, AGE, SEX)
C(C#, CNAME, TEACHER)
SC(S#, C#, GRADE)
其中 S 为学生信息表、SC 为选课表、C 为课程信息表；S#、C#分别为 S、C 表的主码，(S#, C#)是 SC 表的主码，也分别是参照 S、C 表的外码
用户有一查询语句：

```sql
Select SNAME
From S, SC, C
Where SC.S#=S.S# and SC.C#=C.C# and CNAME=“数据库”
```
检索选学“数据库”课程的学生的姓名。
(1)写出以上 SQL 语句所对应的关系代数表达式。
(2)画出上述关系代数表达式所对应的查询计划树。使用启发式查询优化算法，对以上查询计划树进行优化，并画出优化后的查询计划树。
(3)设 SC 表有 10000 条元组，C 表有 50 条元组，S 表中有 1000 条元组，SC 中满足选修数据库课程的元组数为 150，计算优化前与优化后的查询计划中每一步所产生的中间结果大小。

**答：**

**(1)** $\rm\Pi_{SNAME}\left(\sigma_{SC.S\#=S.S\#\wedge SC.C\#=C.C\# \wedge CNAME=\text{``数据库''}}(SC\bowtie C\bowtie S)\right)$ 

**(2)** 上述关系代数表达式对应的查询计划树以及优化后的查询计划树如下所示：
![](./hw5.assets/4(2).drawio-1702649966340-30.png)

**(3)** 优化前与优化后的查询计划中每一步所产生的中间结果大小如下所示：
![](./hw5.assets/4(3).drawio.png)



五、 给定以下关系模式，
Student (sid, sname, major)
Course (cid, cname, credit)
Enrollment (<u>sid, cid</u>, grade)
(1) 考虑以下的 SQL 查询语句，绘制其查询计划树。

```sql
SELECT C.name
FROM Student S, Course C, Enrollment E
WHERE S.sid = E.sid
AND C.cid = E.cid
AND S.major = 'Computer Science' 
AND C.credit >= 90;
```
(2) 假设在 Student.major 和 Enrollment.sid 上建有索引，绘制优化后的查询计划树。

**答：**

**(1)** 该 SQL 查询语句的查询计划树为：
![](./hw5.assets/5(1).drawio-1702649994518-32.png)

**(2)** 优化后的查询计划树如下：
![](./hw5.assets/5(2).drawio-1702650958898-39.png)



六、已知一个关系数据库的模式如下：
关系 B(<u>bno</u>, bname, author)为图书表，其中 bno 为书号，bname 为书名，author 为作者；
关系 S(<u>sno</u>, sname, dept)为学生表，其中 sno 为学号，sname 为姓名，dept 为学生所在系；
关系 L(<u>sno</u>, bno, date)为借书表，其中 sno 为学号，bno 为书号，date 为借书时间。
回答下列问题：
(1) 绘制下面的 SQL 查询语句的逻辑查询计划树。

```sql
SELECT author FROM B NATURAL JOIN S NATURAL JOIN L
WHERE date = ‘2023-11-01’ AND dept = ‘Math’;
```
(2) 使用启发式查询优化方法对上面的逻辑查询计划树进行优化，绘制优化后得到的逻辑查询计划树，具体说明你进行这些优化的理由。

**答：**

**(1)** 该 SQL 查询语句的逻辑查询计划树如下：
![](./hw5.assets/6(1).drawio.png)

**(2)** 优化后的查询计划树如下：
![](./hw5.assets/6(2).drawio.png)

① 将选择操作移到尽可能靠近叶节点，这样能减小中间结果的数量，减少连接操作的执行时间，从而降低整个查询的执行时间；

② 将投影操作移到京可能靠近叶节点，这样能减小中间结果单个元组的大小，从而减小中间结果在磁盘上占用的空间，同时能增大一个块容纳的元组个数，一次 I/O 操作能读入更多的元组，从而减小了 I/O 开销；

③ 用连接操作替代笛卡尔积和相继的选择操作，有效地减少了中间结果的大小，缩短了查询时间。
